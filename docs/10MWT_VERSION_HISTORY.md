# 10MWT Gait Analyzer 버전별 변경 이력

## 개요

10MWT(10-Meter Walk Test) 보행 분석기는 **MediaPipe Pose Heavy**를 사용하여 카메라 영상에서 보행 시간을 자동 측정합니다. 초기 버전(v1)의 단순한 픽셀 높이 기반 방식에서, 현재 버전(v8)의 역수 높이(1/h) + 실제 속도 기반 방식으로 발전하며 정확도가 크게 향상되었습니다.

---

## 버전별 비교 요약

| 버전 | 거리 추정 방식 | 보행 구간 감지 | 측정 구간 | 보정 계수 | MAE |
|------|---------------|---------------|-----------|-----------|-----|
| v1~v2 | 픽셀 높이(h) 직접 사용 | 누적 높이 변화(15%~85%) | 전체 보행 구간 | 없음 | 수 초 |
| v3~v4 | 픽셀 높이(h) + 속도 기반 | 픽셀 속도(dh/dt) 기반 | 가속 구간 제외 | 단순 비율 | ~1초 |
| v5 | **1/h (역수 높이)** 도입 | **실제 속도(d(1/h)/dt)** 도입 | INV_H_START_FRACTION | CORRECTION_FACTOR | ~0.1초 |
| v5.1 | 1/h + percentile | percentile + 비대칭 threshold | 동일 | 동일 | ~0.08초 |
| v7 | 1/h | 실제 속도 (percentile=86) | START_FRACTION=0.60 | 2.4879 | 0.052초 |
| **v8** | **1/h** | **실제 속도 (percentile=82)** | **START_FRACTION=0.60** | **2.4974** | **0.015초** |

---

## v1~v2: 픽셀 높이 직접 사용 (초기 버전)

### 원리
- MediaPipe로 감지한 사람의 **픽셀 높이(h)** 를 직접 사용
- 카메라에서 멀어질수록 h가 줄어드는 것을 이용하여 거리 추정

### 보행 구간 감지
- **누적 높이 변화** 기반: 전체 높이 변화의 15%~85% 구간을 보행 구간으로 설정
- 시작과 끝의 idle 구간을 자르는 단순한 방식

### 시간 측정
- 보행 구간의 시작~끝 시간 차이를 그대로 사용
- 보정 계수 없음

### 한계
- 픽셀 높이(h)는 거리에 비례하지 않음 (h ∝ 1/거리)
- 가까운 곳에서의 1px 변화와 먼 곳에서의 1px 변화가 다른 실제 거리를 의미
- 가속 구간과 측정 구간의 구분 없음
- **오차: 수 초 단위**

---

## v3~v4: 픽셀 속도(dh/dt) 기반 감지

### 개선점
- **픽셀 속도(dh/dt)** 를 계산하여 보행 구간 감지에 사용
- 가속 구간(2m)을 제외하려는 시도

### 보행 구간 감지
- 프레임 간 픽셀 높이 변화율(dh/dt)을 계산
- 일정 threshold 이상인 구간을 보행 구간으로 판단

### 한계
- **핵심 문제**: 픽셀 속도(dh/dt)는 거리에 따라 달라짐
  - 가까운 곳(2~4m): dh/dt가 큼 (큰 픽셀 변화)
  - 먼 곳(10~12m): dh/dt가 작음 (작은 픽셀 변화)
- 같은 실제 속도로 걷더라도 멀어질수록 픽셀 변화가 줄어들어 "멈춘 것처럼" 보임
- 빠른 보행자가 더 긴 idle 시간을 가질 경우, 시간이 역전되는 문제 발생
- **오차: ~1초 단위**

---

## v5: 1/h (역수 높이) 도입 - 핵심 전환점

### 핵심 발견: 핀홀 카메라 모델
```
h_pixel = f * H_real / d     (핀홀 카메라 공식)
→ 1/h = d / (f * H_real)
→ 1/h ∝ d (실제 거리에 비례!)
→ d(1/h)/dt ∝ v (실제 속도에 비례!)
```

- **1/h**는 실제 거리(d)에 **선형 비례** → 거리 추정이 정확
- **d(1/h)/dt**는 실제 보행 속도(v)에 비례 → 거리에 무관하게 일정

### 거리 추정 방식
- 픽셀 높이(h) 대신 **1/h (역수 높이)** 사용
- 1/h 곡선의 선형 보간으로 2m/12m 지점 매핑

### 보행 구간 감지
- **실제 속도 d(1/h)/dt** 계산
- 실제 속도가 일정 threshold 이상인 구간을 보행으로 판단
- 거리에 무관하게 일정한 값이므로, 먼 곳에서도 정확한 감지 가능

### 측정 방법
1. 보행 구간 내 1/h 곡선에서 **INV_H_START_FRACTION** 비율 지점을 측정 시작점으로 설정
2. 보행 종료 지점까지의 시간 × **CORRECTION_FACTOR** = 10m 보행 시간
3. 초반 가속/근거리 노이즈 회피

### 스무딩 파이프라인
```
원본 h → 미디안 필터(ws=9) → 이동평균(ws=15) → 1/h 계산 → d(1/h)/dt
```

### 성능
- **오차: ~0.1초 단위** (이전 대비 10배 개선)

---

## v5.1: percentile + 비대칭 threshold

### 개선점
- **max_rv 계산**: 단순 max 대신 **percentile 기반** (노이즈 스파이크 방지)
- **비대칭 threshold**: walk_end에 **VEL_END_FACTOR** 배 높은 threshold 적용
  - 보행 시작(start): `max_rv × VEL_THRESHOLD_PCT%`
  - 보행 종료(end): `시작 threshold × VEL_END_FACTOR`
- **2-pass 반복 정제(iterative)**: 1차 보행 구간 내에서 max_rv를 재계산하여 2차 정제

### 이유
- 보행 시작과 종료의 속도 프로파일이 비대칭 (가속이 감속보다 빠름)
- 노이즈 스파이크가 max_rv를 왜곡하는 문제 해결
- **오차: ~0.08초**

---

## v7: 파라미터 최적화

### v5.1 대비 변경된 파라미터

| 파라미터 | v5.1 이전 | v7 |
|----------|----------|-----|
| INV_H_START_FRACTION | 다양 | **0.60** |
| VEL_THRESHOLD_PCT | 다양 | **23%** |
| VEL_PERCENTILE | 다양 | **86** |
| VEL_END_FACTOR | 다양 | **1.9** |
| CORRECTION_FACTOR_AWAY | 다양 | **2.4879** |

### 의미
- INV_H_START_FRACTION=0.60: 1/h 변화의 **60% 지점(약 7.2m)** 부터 측정 시작
  - 초반 가속 구간 + 근거리 MediaPipe 노이즈를 회피
  - 실질적으로 7.2m~12m 구간(약 4.8m)만 측정 후 보정 계수로 10m 환산
- VEL_PERCENTILE=86: 상위 14%의 속도 스파이크 제거

### 성능
- **MAE: 0.052초**, Max: 0.089초
- 4개 참조 영상 (7.33s, 7.58s, 9.33s, 10.43s) 기준

---

## v8: 현재 버전 (최종 최적화)

### v7 대비 변경된 파라미터

| 파라미터 | v7 | v8 | 변경 이유 |
|----------|-----|-----|-----------|
| VEL_THRESHOLD_PCT | 23% | **27%** | 더 엄격한 보행 시작 감지 |
| VEL_PERCENTILE | 86 | **82** | 더 많은 속도 데이터 포함 |
| VEL_END_FACTOR | 1.9 | **1.7** | 보행 종료 감지 민감도 조정 |
| CORRECTION_FACTOR_AWAY | 2.4879 | **2.4974** | 새 캐시 기반 재최적화 |

### 불변 파라미터

| 파라미터 | 값 | 설명 |
|----------|-----|------|
| INV_H_START_FRACTION | 0.60 | 1/h 곡선 60% 지점부터 측정 |
| SMOOTH_MEDIAN_WS | 9 | 미디안 필터 윈도우 |
| SMOOTH_AVG_WS | 15 | 이동평균 윈도우 |
| VEL_ITERATIVE | True | 2-pass 반복 정제 |
| MODEL_COMPLEXITY | 2 | MediaPipe Heavy |

### 성능 (4개 참조 영상)

| 지표 | v7 | v8 | 개선율 |
|------|-----|-----|--------|
| MAE | 0.052초 | **0.015초** | 71% 향상 |
| Max Error | 0.089초 | **0.030초** | 66% 향상 |
| LOO MAE | 0.069초 | **0.018초** | 74% 향상 |

### 캐시 재구축
- v8에서 프레임 데이터 캐시(`frame_data_cache_v2.pkl`)를 재구축
- MediaPipe 출력이 버전/환경에 따라 미세하게 달라질 수 있어 캐시 갱신 필수

---

## 현재 분석 파이프라인 (v8) 상세

### 1단계: 프레임 추출
```
영상 → MediaPipe Pose Heavy (complexity=2) → 33개 키포인트/프레임
```
- 머리(nose_y) ~ 발(avg(ankle_y)) 높이 = **pixel_height(h)**
- 매 프레임마다 추출

### 2단계: 스무딩
```
h → 미디안 필터(ws=9) → 이동평균(ws=15) → smoothed_h
```
- 미디안 필터: 이상치(outlier) 제거
- 이동평균: 부드러운 곡선 생성

### 3단계: 1/h + 실제 속도 계산
```
1/h = 1 / max(smoothed_h, 1.0)     ← 실제 거리에 비례
real_vel = d(1/h)/dt                ← 실제 속도에 비례
```

### 4단계: 보행 구간 감지
```
1) positive_rv에서 82th percentile → max_rv
2) threshold_start = max_rv × 27%
3) threshold_end = threshold_start × 1.7
4) real_vel >= threshold 구간 → 보행 구간 (최소 2초)
5) 2-pass 반복: 보행 구간 내 max_rv 재계산 → 더 정밀한 구간
```

### 5단계: 측정점 결정
```
inv_h_at_2m = inv_h_start + 0.60 × (inv_h_end - inv_h_start)
→ 1/h 변화의 60% 지점 = 약 7.2m 위치
time_2m = 해당 지점의 시간 (선형 보간)
time_12m = 보행 종료 시간
```

### 6단계: 시간 계산
```
raw_walk_time = time_12m - time_2m        (약 4.8m 구간)
walk_time = raw_walk_time × 2.4974        (10m로 환산)
walk_speed = 10.0 / walk_time             (m/s)
```

---

## 핵심 교훈

### 1. 픽셀 높이(h) vs 역수 높이(1/h)
- h는 1/거리에 비례 → 비선형, 거리가 멀수록 변화량 작음
- **1/h는 거리에 선형 비례** → 일정 속도 보행 시 직선 그래프

### 2. 픽셀 속도(dh/dt) vs 실제 속도(d(1/h)/dt)
- dh/dt는 거리에 따라 변함 → 먼 곳에서 보행 감지 불가
- **d(1/h)/dt는 거리에 무관** → 어디서든 일정한 속도 감지

### 3. MediaPipe 한계
- 5m 이상 거리에서 pixel height를 과대추정 (랜드마크 분산)
- 원거리에서 1/h 노이즈 증폭 (1px 오차가 큰 1/h 오차로)
- → INV_H_START_FRACTION=0.60으로 초반 노이즈 구간 스킵

### 4. 최적화 주의사항
- 캐시와 분석기의 `_extract_frame_data()` 로직이 반드시 일치해야 함
  - 머리: nose_y, 발: avg(left_ankle_y, right_ankle_y)
- MediaPipe 버전/환경 변경 시 캐시 재구축 필수
